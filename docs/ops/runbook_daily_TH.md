# Runbook งานประจำวัน (ทีมปฏิบัติการคลัง)

เอกสารนี้ครอบคลุมรอบการทำงานตามวันทำการปกติสำหรับชุดฟีเจอร์ PR6 (A1–A5)

## ทุกเช้าก่อนเปิดขาย (ประมาณ 15 นาที)
1. เข้าระบบที่ `/admin/dashboard`
   - ตรวจสอบป๊อปอัปแจ้งเตือน **สต็อกต่ำ** และ **ล็อตใกล้หมดอายุ**
   - หากรายการแก้ไขแล้ว กด "ทำเครื่องหมายว่าอ่านแล้ว" เพื่อไม่ให้แจ้งเตือนซ้ำ
   - ถ้ายังจัดการไม่ได้ ให้กด "งดเตือนวันนี้" (ระบบจะ snooze เฉพาะบัญชีของผู้ใช้ที่กด)
   - จดบันทึกจำนวนรายการแจ้งเตือนในสรุปรายวัน
2. เปิดหน้า **รายงาน ▸ ใกล้หมดอายุ**
   - ตั้งค่า `expiring_days` เป็น 30 วัน (หรือค่าที่ทีมบริหารกำหนด)
   - ตรวจสอบว่ามีเฉพาะล็อตที่หมดอายุใน 30 วันหรือรายการหมดอายุจริง
   - กด "ส่งออก CSV" และแนบไฟล์ในอีเมลสรุปเช้า
3. เปิดหน้า **รายงาน ▸ สต็อกต่ำ**
   - ตรวจ `qty_total` เมื่อเทียบกับ `reorder_point`
   - ส่งออก CSV และส่งให้ทีมจัดซื้อ/พยาบาลพร้อมข้อเสนอแนะการเติมสต็อก

## ระหว่างวัน (ทุก 4 ชั่วโมง หรือหลังการรับ/เบิกครั้งใหญ่)
1. ตรวจหน้า **การเคลื่อนไหวสต็อก** (`/admin/stock-movements`)
   - ตรวจสอบการรับ/เบิกว่าระบุ `รหัสล็อต (lot_no)` ครบ
   - หากมีการเบิกรวดเดียวหลายครั้ง ให้ยืนยันว่าปริมาณไม่ติดลบ
2. เมื่อต้องนำเข้าไฟล์ล็อต
   - ใช้ปุ่ม **พรีวิว 20 แถวแรก** เพื่อตรวจข้อผิดพลาดก่อนยืนยัน
   - หากระบบแจ้งแถวผิด ให้ดาวน์โหลด `error.csv` และส่งกลับทีมข้อมูลเพื่อแก้ไข
3. ตรวจ `storage/logs/laravel.log` อย่างน้อยวันละหนึ่งครั้ง ว่าไม่มี error จากงาน scheduler หรือ import

## ตรวจสอบ scheduler และ cron
1. บนเซิร์ฟเวอร์รอบเช้า รัน `php artisan schedule:run --verbose --once` เพื่อตรวจว่า job สำคัญสำเร็จ
2. รัน `php artisan schedule:list` สัปดาห์ละหนึ่งครั้งเพื่อยืนยันว่ามี job เคลียร์แจ้งเตือน/สำรองข้อมูลครบ
3. ตรวจ timestamp ด้านล่างรายงาน expiring/low-stock ว่าตรงกับเวลารอบล่าสุด หากไม่ตรงให้เช็ก cron

## การสำรองข้อมูล (รอบเย็นทุกวัน)
1. รัน `php artisan inventory:backup`
2. ดาวน์โหลดไฟล์จากหน้า **Admin ▸ Backup** และอัปโหลดสู่ที่เก็บกลาง (S3/Nextcloud)
3. อัปเดต log ประจำวัน (วันที่, ผู้รับผิดชอบ, ขนาดไฟล์, สถานะ restore test ล่าสุด)

## การจัดทำรายงานสรุปประจำวัน
- แนบ CSV รายงาน **ใกล้หมดอายุ** + **สต็อกต่ำ** พร้อมจำนวนรายการทั้งหมด
- ระบุสถานะ import ล่าสุด (STRICT/LENIENT) และจำนวนแถวที่มี error
- หากมีการ snooze แจ้งเตือนข้ามวัน ให้บันทึกไว้เพื่อทบทวนวันถัดไป
- สรุปยอด movement ล่าสุด (รับ/เบิก/ปรับ) เพื่อให้ทีมบริหารทราบแนวโน้ม
