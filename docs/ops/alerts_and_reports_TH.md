# การใช้งานป๊อปอัปแจ้งเตือนและรายงาน (A4)

## การตั้งค่าระยะวันหมดอายุ (`expiring_days`)
1. เข้า **Admin ▸ ตั้งค่าระบบ**
2. กรอกค่าเป็นวัน เช่น `15,30,60` (คั่นด้วยเครื่องหมายจุลภาค) เพื่อกำหนดช่วงที่ต้องแจ้งเตือน
3. กดบันทึก แล้วกดปุ่ม **สแกนแจ้งเตือนทันที** เพื่อตรวจว่ามีการสร้าง snapshot ใหม่

## ป๊อปอัปแจ้งเตือนแบบคงอยู่ (Persistent Alerts)
- Modal จะปรากฏบน dashboard เมื่อ snapshot มีข้อมูล Low Stock หรือ Expiring
- ปุ่ม **ทำเครื่องหมายว่าอ่านแล้ว** จะสร้าง record ใน `user_alert_states` เฉพาะ user นั้น โดยผูกกับ `payload_hash`
- ปุ่ม **งดเตือนวันนี้** จะตั้งค่า `snooze_until` ถึงสิ้นวัน (ใช้ `Carbon::endOfDay()`); modal จะไม่ขึ้นอีกจนถึงวันถัดไป
- หาก payload เดิมกลับมาอีกครั้ง ระบบไม่สร้าง record ซ้ำ แต่จะอัปเดต timestamp ให้เพื่อตรวจสอบย้อนหลังได้
- ทดสอบการสร้างแจ้งเตือนด้วยคำสั่ง `php artisan inventory:scan-alerts`

### การล้างสถานะเมื่อมีปัญหา
- ใช้แนวทางใน [ops/recovery/alerts_muting.md](../../ops/recovery/alerts_muting.md) เพื่อปิดเสียงแจ้งเตือนชั่วคราวและล้างเฉพาะ payload ที่เป็นปัญหา

## การดูรายงานบนระบบ
### รายงานล็อตใกล้หมดอายุ
- URL: `/admin/reports/expiring-batches`
- เลือกตัวกรองวัน (7/15/30/60/90) หรือ `expired` เพื่อดูล็อตที่หมดอายุแล้ว
- สามารถกรองตามหมวดสินค้าและสถานะได้
- ปุ่ม "ส่งออก CSV" จะได้ข้อมูล `sku,name,lot_no,expire_date,qty,category` โดยไม่มีคอลัมน์ราคา

### รายงานสต็อกต่ำ
- URL: `/admin/reports/low-stock`
- `qty_total` เป็นการรวมยอดทุกล็อตที่ active; ใช้เทียบกับ `reorder_point`
- มีตัวกรองหมวดสินค้า, สถานะ, และคำค้นหา SKU/ชื่อสินค้า
- CSV จะประกอบด้วย `sku,name,qty_total,reorder_point,category` เท่านั้น

## การแจ้งเตือนออกนอกระบบ (อีเมล/LINE)
- ตั้งค่าที่ **Admin ▸ ตั้งค่าระบบ** ช่อง `notify_channels`
- กดปุ่ม **ทดสอบการแจ้งเตือน** เพื่อให้ระบบส่งข้อความ `[ทดสอบ] แจ้งเตือนสต็อก` ไปยังทุกช่องทางที่ตั้งค่าไว้
- ตรวจ log `storage/logs/laravel.log` หากไม่สามารถส่งได้ (เช่น SMTP fail)

## เคล็ดลับปฏิบัติ
- ผู้ใช้แต่ละคนมี state แยกกัน: หากผู้ใช้งานหนึ่งกดอ่าน อีกคนยังคงเห็น modal ตามปกติ
- รายงานทั้งสองมีปุ่ม export อยู่ในหน้าเดียวกับการนำเข้าล็อต ช่วยให้ผู้ใช้สามารถดาวน์โหลดแบบเร็วได้จากหน้าเดียวกัน
- หากต้องตรวจสอบ payload ล่าสุดให้ใช้ `php artisan tinker` และเรียก `app(App\Services\AlertSnapshotService::class)->buildSnapshot()`
