# ฟอร์มเคลื่อนไหวสินค้า + การจัดการ LOT (PR2)

## ภาพรวม UX ฟอร์ม

### 1) รับของเข้าคลัง (Receive)
- แบบฟอร์มใช้เมนูเลือกสินค้า (Select2) เท่านั้น ไม่มีช่องให้กรอกเลข LOT เอง
- ใส่จำนวน (จำนวนเต็มไม่ติดลบ), วันหมดอายุ (ถ้ามี) และหมายเหตุได้
- เมื่อบันทึก ระบบเลือก/สร้าง LOT อัตโนมัติ หากไม่มี LOT ที่วันหมดอายุเดียวกันจะสร้างเลขใหม่ (`LOT-xx`) พร้อมบันทึก `received_at`

### 2) เบิกของออก (Issue)
- เลือกสินค้า จากนั้นเลือกรายการ LOT ที่คงเหลือมากกว่า 0
- หากไม่เลือก LOT ให้ระบบเลือกตามกติกา FEFO (วันหมดอายุน้อยสุดที่ยังมีคงเหลือ)
- ช่องหมายเหตุเป็นอิสระ
- ปุ่ม “+ สร้างล็อตใหม่” จะเปิดโมดัลเพื่อสร้าง LOT ทันที (ใส่วันหมดอายุ/หมายเหตุได้) หลังบันทึกระบบจะเพิ่มล็อตใหม่ใน Select ให้อัตโนมัติ

### 3) ปรับยอดสต็อก (Adjust)
- ต้องเลือกสินค้าและ LOT ที่ต้องการปรับ พร้อมระบุ “จำนวนใหม่” (ไม่ติดลบ)
- ใช้โมดัลเดียวกับการสร้าง LOT ใหม่ได้
- ระบบบันทึก movement ประเภท `adjust` พร้อม delta (Δ) ในหมายเหตุ

## การแสดงผล LOT และเครื่องมือในหน้าแสดงสินค้า
- หน้า `products/show` มีแท็บ “ล็อต (LOT)” แสดงตาราง: LOT | วันหมดอายุ | คงเหลือ | สถานะ | เครื่องมือ
- ปุ่มเครื่องมือเชื่อมไปยังหน้าฟอร์มเคลื่อนไหวโดยระบุ `form_type` (`receive`, `issue`, `adjust`) และเลือก LOT ล่วงหน้า

## กติกา FEFO / การเลือก LOT อัตโนมัติ
- เวลาเบิก (`issue`) ถ้าไม่ได้ระบุ LOT:
  - ระบบจะเลือก LOT ที่เป็น `is_active = true`, `qty > 0`
  - เรียงตามวันหมดอายุ (น้อยสุดก่อน) และเวลารับเข้า (`received_at`) เพื่อป้องกันการค้างสต็อก
  - ถ้าไม่มี LOT เหมาะสม จะคืน Validation error

## วิธีทดสอบเร็ว
1. เข้าหน้าสินค้า → แท็บ LOT → “+ เพิ่มล็อตใหม่” แล้วตรวจสอบว่าขึ้นเลข `LOT-02`
2. ใช้ฟอร์ม “รับของ” รับสินค้าจำนวนหนึ่งโดยไม่เลือก LOT → ตรวจดูว่า LOT ใหม่ถูกสร้างและคงเหลือเพิ่ม
3. ใช้ฟอร์ม “เบิกของ” โดยไม่เลือก LOT → ควรตัดจากล็อตที่ใกล้หมดอายุก่อน
4. ใช้ฟอร์ม “ปรับยอด” เลือก LOT เดิม → ปรับจำนวน → ตรวจในประวัติว่ามี movement `adjust` และยอดไม่ติดลบ
5. เปิดประวัติในหน้า `เคลื่อนไหวสต็อก` ตรวจดูว่าประเภทแสดงเป็นไทย (รับเข้า/เบิกออก/ปรับยอด) และจำนวนขึ้น + / - / Δ ถูกต้อง

> หมายเหตุ: PR นี้ยังไม่แตะระบบราคา/รายงาน/แจ้งเตือน (รอใน PR ถัดไป)
