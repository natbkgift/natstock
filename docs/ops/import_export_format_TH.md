# ฟอร์แมตนำเข้า/ส่งออกล็อตสินค้า

## คอลัมน์มาตรฐาน (CSV/XLSX)
| คอลัมน์ | บังคับ | หมายเหตุ |
| --- | --- | --- |
| `sku` | ✔ | รหัสสินค้าแม่ (ตัวอักษร/ตัวเลข ไม่เกิน 64 ตัว) |
| `sub_sku` | ✔ | รหัสล็อตย่อย, ใช้ `UNSPECIFIED` เมื่อไม่ต้องการระบุ |
| `name` | ✱ | ถ้าเว้นว่างจะใช้ชื่อเดิมของสินค้า |
| `category` | ✱ | จำเป็นเมื่อ auto-create ถูกปิด |
| `qty` | ✔ | จำนวนยอดคงเหลือต่อล็อต (จำนวนเต็ม ≥ 0) |
| `expire_date` | ✱ | รูปแบบ `Y-m-d` หรือเว้นว่าง |
| `reorder_point` | ✱ | ระดับสต็อกต่ำของสินค้า (จำนวนเต็ม ≥ 0) |
| `note` | ✱ | บันทึกเพิ่มเติมต่อแถว |
| `is_active` | ✱ | `1/0`, `true/false` |

> **หมายเหตุ**: คอลัมน์ `cost_price`, `sale_price` จะถูกเพิกเฉยโดยระบบ (ไม่ว่าจะกรอกหรือไม่) เมื่อ flag ราคาปิดอยู่

## โหมดการนำเข้า
- **UPSERT**: อัปเดตหรือสร้างล็อตสินค้าโดยตั้งค่ายอดคงเหลือให้ตรงกับในไฟล์ ระบบจะบันทึก movement ประเภท `in` (เพิ่ม) หรือ `out` (ลด) ตามส่วนต่างของจำนวนโดยอัตโนมัติ พร้อมโน้ต `Δ±จำนวน`
- **SKIP**: หากพบล็อตเดิมที่มีอยู่ในระบบแล้ว จะไม่ทำการแก้ไขใดๆ แต่ยังคงสร้างล็อตใหม่ที่ไม่มีในระบบได้ (พร้อม movement `receive`)

## ระดับความเข้มงวด
| โหมด | พฤติกรรม |
| --- | --- |
| STRICT | รันภายใต้ธุรกรรมเดียว (ครอบโดย ops) หากพบ error ให้ rollback ทั้งไฟล์และแก้ไขก่อนนำเข้าใหม่ |
| LENIENT | แถวถูกต้องจะถูก commit, แถวผิดถูกบันทึกใน `error.csv` และรายงานในผลลัพธ์ |

## ขั้นตอนปฏิบัติ
1. เข้าเมนู **Admin ▸ นำเข้า/ส่งออกล็อตสินค้า**
2. เลือกไฟล์ตามเทมเพลตด้านบน แล้วกด "พรีวิว"
3. ตรวจ 20 แถวแรก: ข้อผิดพลาดจะมีพื้นสีแดง/ข้อความเตือน
4. เลือกโหมดซ้ำ (UPSERT/DELTA/SKIP) และเลือก STRICT หรือ LENIENT ตามนโยบายประจำวัน
5. กด "ยืนยันนำเข้า" และดาวน์โหลด `error.csv` หากระบบสร้างลิงก์ให้

## ตัวอย่าง CSV
```csv
sku,sub_sku,name,category,qty,expire_date,reorder_point,note,is_active
SKU-001,LOT-A,หน้ากากอนามัย,อุปกรณ์แพทย์,25,2025-01-31,10,ล็อตแรก,true
SKU-001,LOT-B,หน้ากากอนามัย,อุปกรณ์แพทย์,12,,10,,true
SKU-002,UNSPECIFIED,เจลล้างมือ,เวชภัณฑ์,5,2024-12-15,5,ล็อตทดลอง,false
```

## การส่งออก
- **Expiring batches**: `sku,name,sub_sku,expire_date,qty,category`
- **Low stock**: `sku,name,qty_total,reorder_point,category`
- ระบบ escape ค่าอันตราย (`=+-@`) โดยเติม `''` นำหน้าอัตโนมัติ
