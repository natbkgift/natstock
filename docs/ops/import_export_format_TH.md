# ฟอร์แมตและโหมดนำเข้า/ส่งออกล็อตสินค้า

## โครงสร้างไฟล์นำเข้า (CSV/XLSX)
| คอลัมน์ | บังคับ | หมายเหตุ |
| --- | --- | --- |
| `sku` | ✔ | รหัสสินค้า (64 อักขระ) ต้องตรงกับสินค้าที่มีอยู่หรือให้ระบบสร้าง (เมื่อเปิด auto-create) |
| `sub_sku` | ✔ | รหัสล็อต (16 อักขระ) หากไม่ระบุให้ใช้ `UNSPECIFIED` ระบบจะสร้างล็อตใหม่อัตโนมัติ |
| `name` | ✱ | ใช้ชื่อเดิมถ้าเว้นว่าง, จำเป็นเมื่อเป็นสินค้าที่สร้างใหม่ |
| `category` | ✱ | ใช้สำหรับสร้างหมวดหมู่ใหม่ถ้าเปิด auto-create (ตัวอย่างใน `docs/ops/samples/`)
| `qty` | ✔ | จำนวนเต็ม ≥ 0 (สำหรับ DELTA สามารถใส่ค่าติดลบเพื่อหักยอด)
| `expire_date` | ✱ | รูปแบบ `YYYY-MM-DD`, เว้นว่างได้สำหรับสินค้าที่ไม่หมดอายุ |
| `reorder_point` | ✱ | ใช้กรณีสร้างสินค้าใหม่, หากเว้นไว้จะคงค่าปัจจุบัน |
| `note` | ✱ | บันทึกเพิ่มเติมต่อแถว |
| `is_active` | ✱ | `1/0` หรือ `true/false` |

> เมื่อ `INVENTORY_ENABLE_PRICE=false` คอลัมน์ `cost_price` และ `sale_price` จะถูกแสดงว่า **ignored** ในหน้าพรีวิวและไม่ถูกบันทึกลงระบบ
>
> **สำคัญ:** โหมดการนำเข้า (UPSERT/DELTA/SKIP) ถูกเลือกที่หน้าพรีวิวและมีผลกับทั้งไฟล์ ไม่รองรับการกำหนดโหมดต่อแถวใน CSV

## โหมดการนำเข้า
- **UPSERT (REPLACE)** — ตั้งยอดล็อตให้ตรงกับไฟล์, ระบบสร้าง movement ประเภท `adjust` พร้อมบันทึกก่อน/หลัง
- **UPSERT (DELTA)** — กรอกยอดที่จะเพิ่ม/ลด, ระบบสร้าง movement `receive` (ค่าบวก) หรือ `issue` (ค่าลบ)
- **SKIP** — ล็อตที่มีอยู่แล้วจะไม่ถูกแก้, ระบบจะสร้างเฉพาะล็อตใหม่และ movement `receive`

## ระดับความเข้มงวด
| ระดับ | พฤติกรรม |
| --- | --- |
| STRICT | ครอบธุรกรรมทั้งไฟล์: เจอ error แถวเดียว rollback ทั้งหมด, ต้องแก้แล้วนำเข้าใหม่ |
| LENIENT | แถวถูก commit ทีละแถว, แถวผิดถูกบันทึกใน `error.csv` (ดาวน์โหลดได้จากผลลัพธ์) |

> แนะนำ: ใช้ STRICT สำหรับงาน routine ปกติ และสลับ LENIENT เมื่อจำเป็นต้องทยอยแก้ไขข้อมูล (มีตัวอย่างการกู้คืนใน `ops/recovery/restore_import_failures.md`)

## ขั้นตอนแนะนำ
1. เข้าเมนู **Admin ▸ นำเข้า/ส่งออกล็อตสินค้า**
2. อัปโหลดไฟล์และกด "พรีวิว" — ระบบจะแสดง 20 แถวแรกพร้อม highlight ข้อผิดพลาด
3. ตรวจสรุปด้านบน (จำนวนแถว, คอลัมน์ที่ถูก ignore, หมวดหมู่ที่จะสร้างใหม่)
4. เลือกโหมด (UPSERT/DELTA/SKIP) และระดับ STRICT หรือ LENIENT
5. ยืนยันการนำเข้า, ดาวน์โหลด `error.csv` ถ้ามี และเก็บ log ตาม runbook

## ตัวอย่างไฟล์
- [sample_import_batches.csv](samples/sample_import_batches.csv) — กรณี UPSERT/REPLACE ตั้งยอดตรงกับไฟล์
- [sample_import_batches_delta.csv](samples/sample_import_batches_delta.csv) — กรณี DELTA เพิ่ม/ลดยอดจากสต็อกปัจจุบัน

## การส่งออกที่เกี่ยวข้อง
- **รายงานล็อตใกล้หมดอายุ**: `sku,name,lot_no,expire_date,qty,category`
- **รายงานสต็อกต่ำ**: `sku,name,qty_total,reorder_point,category`
- ปุ่มลัดดาวน์โหลดอยู่ในหน้าเดียวกับฟอร์มนำเข้า (`import_export.index`)
- ระบบ escape ค่าอันตราย (`=`, `+`, `-`, `@`) โดยเพิ่ม `'` นำหน้าเพื่อป้องกัน CSV injection
