# inventory-app (Phase 4 — นำเข้าไฟล์ ภาษาไทย)

โปรเจกต์ระบบบริหารสต็อกสินค้าพัฒนาด้วย Laravel 11 (PHP 8.3) โดยเน้นภาษาไทยทั้งหมดสำหรับทีมงานในคลังสินค้า ชุดนี้คือ Phase 1 ที่เตรียมโครงสร้างพื้นฐาน ระบบยืนยันตัวตน และเมนูหลังบ้านเบื้องต้น

## ความต้องการระบบ
- PHP 8.3
- Composer 2
- SQLite 3 (ใช้สำหรับการทดสอบ/CI)
- Node.js 20+ (ใช้สำหรับจัดการ dependency ของ Vite หากจำเป็น)

## ขั้นตอนติดตั้งเบื้องต้น
1. ติดตั้ง dependency ของ PHP
   ```bash
   composer install
   ```
2. สร้างไฟล์สิ่งแวดล้อม
   ```bash
   cp .env.example .env
   ```
3. สร้างคีย์แอปและ migrate ฐานข้อมูล SQLite
   ```bash
   php artisan key:generate
   php artisan migrate
   php artisan db:seed
   ```
4. เริ่มเซิร์ฟเวอร์ทดสอบ
   ```bash
   php artisan serve
   ```
5. เข้าถึงระบบได้ที่ `http://127.0.0.1:8000` ด้วยบัญชีเริ่มต้น
   - อีเมล: `admin@example.com`
   - รหัสผ่าน: `password`

> Phase 1 ใช้ AdminLTE จาก CDN เพื่อให้โค้ดเบาและตั้งค่าเร็ว โดยจะปรับปรุง build tool ใน Phase ถัดไป

## โครงสร้างเมนูหลังบ้าน (ภาษาไทย)
- แดชบอร์ด — สรุปภาพรวม (placeholder)
- สินค้า — จัดการสินค้า (placeholder)
- หมวดหมู่ — จัดการหมวดหมู่ (placeholder)
- เคลื่อนไหวสต็อก — ประวัติ in/out (placeholder)
- นำเข้าไฟล์ — ระบบนำเข้า CSV/XLSX พร้อมพรีวิว ตรวจสอบ และคอมมิตแบบอะตอมมิก
- รายงาน — รวมรายงาน 3 รูปแบบ (ใกล้หมดอายุ, สต็อกต่ำ, มูลค่าสต็อก) พร้อมตัวกรองภาษาไทยและปุ่มส่งออก CSV

ทุกเมนูอยู่ภายใต้ prefix `/admin/*` และจำเป็นต้องเข้าสู่ระบบก่อนใช้งาน

## สคีมาและความสัมพันธ์ (Phase 2)
- `categories` — เก็บหมวดหมู่สินค้า มีคอลัมน์ชื่อหมวดหมู่ (ไม่ซ้ำ), หมายเหตุ, สถานะการใช้งาน พร้อมดัชนีสำหรับค้นหาหมวดหมู่ที่ใช้งานอยู่
- `products` — เก็บข้อมูลสินค้าแต่ละรายการ เชื่อมโยงกับหมวดหมู่ มีราคาทุน/ราคาขายแบบทศนิยม 2 ตำแหน่ง, วันหมดอายุ, จุดสั่งซื้อซ้ำ, ปริมาณคงเหลือ และสถานะการใช้งาน พร้อม constraint ตรวจสอบค่าตัวเลขไม่ให้ติดลบ
- `stock_movements` — เก็บเหตุการณ์เคลื่อนไหวของสต็อก (เข้า, ออก, ปรับยอด) เชื่อมโยงกับสินค้าและผู้ปฏิบัติ พร้อมบันทึกเวลาที่เกิดเหตุการณ์เป็นเวลาแบบมีโซนเวลา
- `users` — มีบทบาท `admin|staff|viewer` พร้อมดัชนีสำหรับกรองตามบทบาท เพื่อรองรับสิทธิ์การใช้งานในอนาคต

ความสัมพันธ์ในระบบ:
- หมวดหมู่ (Category) 1 รายการ มีสินค้า (Product) ได้หลายรายการ
- สินค้า 1 รายการ มีประวัติการเคลื่อนไหว (StockMovement) ได้หลายเหตุการณ์
- เหตุการณ์เคลื่อนไหวของสต็อก เชื่อมโยงกลับไปยังสินค้า และอาจมีผู้ใช้งาน (User) เป็นผู้ดำเนินการ

Seeder เริ่มต้นสร้างหมวดหมู่ตัวอย่าง 3 กลุ่มและสินค้าเบื้องต้น 4 รายการ เพื่อเตรียมข้อมูลทดสอบสำหรับ Phase 3

## สิ่งที่ครอบคลุมใน Phase 1
- ตั้งค่า locale = `th`, timezone = `UTC`
- ระบบยืนยันตัวตนภาษาไทย (สมัคร, เข้าสู่ระบบ, ลืมรหัสผ่าน)
- กำหนดบทบาทผู้ใช้ `admin`, `staff`, `viewer` พร้อม Gate เบื้องต้น
- Layout หลักใช้ AdminLTE (CDN) พร้อม Breadcrumb และ Flash Message ภาษาไทย
- Seeder สร้างผู้ดูแลระบบเริ่มต้นและ log ภาษาไทย
- ตั้งค่า Laravel Pint (โหมดทดสอบ) และ Pest (Smoke test)
- GitHub Actions workflow รัน composer install → migrate → pint --test → pest

## Phase 4 — ระบบนำเข้าไฟล์สินค้า (ภาษาไทย)
- เส้นทาง `/admin/import` แสดงแบบฟอร์มอัปโหลด + ตัวเลือกโหมดซ้ำ (UPSERT/SKIP) และการสร้างหมวดหมู่อัตโนมัติ
- รองรับไฟล์ `.csv` และ `.xlsx` (สร้างเทมเพลตไว้ที่ `public/templates/product_template.csv` และ `public/templates/product_template.xlsx`)
- หลังอัปโหลดจะแสดงพรีวิว 20 แถวแรกพร้อมสถานะ/ข้อความตรวจสอบ รวมถึงจำนวนแถวทั้งหมดและแถวที่ผิดพลาด
- Validation ภาษาไทยครบถ้วน: SKU, ตัวเลข ≥ 0, วันที่รูปแบบ `YYYY-MM-DD`, สถานะสินค้า 1/0 ฯลฯ พร้อมตีความค่าว่างเป็นค่าเริ่มต้นที่ถูกต้อง
- โหมด UPSERT จะอัปเดตฟิลด์สินค้าและปรับยอดคงเหลือด้วย movement (in/out) ตาม delta, โหมด SKIP ข้าม SKU ที่มีอยู่โดยไม่แก้ไขข้อมูล
- ทุกการคอมมิตทำงานในทรานแซกชันเดียว (atomic) และสรุปผลจำนวนที่สร้าง/อัปเดต/ข้าม/ผิดพลาด
- ถ้ามีแถวผิดพลาด จะสร้างไฟล์ `error.csv` ใน `storage/app/tmp` พร้อมลิงก์ดาวน์โหลดแบบ signed URL เพื่อแก้ไขและอัปโหลดใหม่ภายใน 24 ชม.
- ป้องกัน CSV injection โดย prefix `'` ให้ค่าที่ขึ้นต้นด้วย `= + - @` ทั้งในพรีวิวและไฟล์ error
- ใช้อ่านไฟล์แบบ chunk เพื่อลดหน่วยความจำ และรองรับการสร้างหมวดหมู่ใหม่อัตโนมัติเมื่อเปิดใช้งาน

### คอลัมน์ที่ต้องมีในเทมเพลตนำเข้า
- `sku` (บังคับ, unique, ไม่เว้นวรรค, อนุญาต `._-`)
- `name` (บังคับ)
- `category` (บังคับ)
- `qty`, `cost_price` (บังคับ, ≥ 0)
- `sale_price`, `expire_date`, `reorder_point`, `note`, `is_active` (ไม่บังคับ; `is_active` เริ่มต้นเป็น 1 เมื่อเว้นว่าง)

### ขั้นตอนการนำเข้าโดยสรุป
1. ดาวน์โหลดเทมเพลต CSV/XLSX แล้วกรอกข้อมูล (ต้องบันทึกเป็น UTF-8)
2. เลือกโหมดซ้ำ (UPSERT หรือ SKIP) และกำหนดว่าจะสร้างหมวดหมู่ใหม่อัตโนมัติหรือไม่
3. อัปโหลดไฟล์ → ตรวจสอบพรีวิว 20 แถวแรก หากพบไฟล์ผิดรูปแบบจะแจ้งเป็นภาษาไทยและไม่อนุญาตให้คอมมิต
4. กด “คอมมิต” เพื่อเขียนลงฐานข้อมูลและสร้าง movement พร้อมสรุปผลบนหน้าจอ
5. หากมีแถวผิดพลาด จะมีปุ่ม “ดาวน์โหลด error.csv” สำหรับแก้ไขแล้วนำเข้าใหม่

## Phase 5 — รายงาน (ภาษาไทย) + ส่งออก CSV
- เมนูรายงาน (`/admin/reports`) เพิ่มการ์ดนำทางไปยังรายงานย่อยทั้งสามแบบ
- รายงานใกล้หมดอายุ (`/admin/reports/expiring`)
  - ตัวกรอง “ภายในกี่วัน” (30/60/90), หมวดหมู่, สถานะสินค้า, คำค้น SKU/ชื่อ
  - ตารางแสดงป้ายแจ้งเตือน “เร่งด่วน/ใกล้หมดอายุ” ตามจำนวนวันคงเหลือ
  - ปุ่ม “ส่งออก CSV” ดาวน์โหลดไฟล์ `expiring_{Nd}_{YYYYMMDD}.csv`
- รายงานสต็อกต่ำ (`/admin/reports/low-stock`)
  - กรองตามหมวดหมู่, สถานะ และคำค้น พร้อมป้าย “สต็อกต่ำ” ชัดเจนในตาราง
  - ส่งออกไฟล์ `low_stock_{YYYYMMDD}.csv`
- รายงานมูลค่าสต็อก (`/admin/reports/valuation`)
  - แสดงราคาทุน, ปริมาณ และมูลค่ารวมพร้อมสรุปยอดรวมด้านล่างตาราง
  - ส่งออกไฟล์ `valuation_{YYYYMMDD}.csv` พร้อมแถว “รวมทั้งสิ้น”
- ทุกไฟล์ CSV ใส่หัวคอลัมน์ภาษาไทย, ป้องกัน CSV injection และบันทึกเป็น UTF-8 (BOM) เพื่อรองรับ Excel ภาษาไทย

## Phase 7 — ความปลอดภัย/สำรอง/แจ้งเตือนอัตโนมัติ
- หน้า “ตั้งค่าระบบ” สำหรับกำหนดค่าการแจ้งเตือน (ช่วงวัน, ช่องทาง, อีเมล, เวลา Cron) พร้อมปุ่มทดสอบและรันสแกนทันที
- คำสั่ง `inventory:scan-alerts` สแกนสินค้าใกล้หมดอายุ/สต็อกต่ำ แล้วส่งแจ้งเตือน In-App/Email/LINE ตามช่องทางที่เลือก
- แจ้งเตือนภายในระบบพร้อมหน้า `/admin/notifications` และป้ายสถานะแจ้งเตือนที่ยังไม่อ่านในเมนู
- ระบบบันทึกกิจกรรม (`/admin/audit-log`) ครอบคลุมการล็อกอิน/ล็อกเอาต์, CRUD สินค้า/หมวดหมู่, เคลื่อนไหวสต็อก, นำเข้าไฟล์ และการเปลี่ยนตั้งค่า
- ระบบสำรองข้อมูล (`/admin/backup`) สามารถสร้างไฟล์สำรอง ดาวน์โหลด และตั้ง Scheduler รายสัปดาห์เก็บล่าสุด 7 ชุด
- เพิ่ม Middleware หัวข้อความปลอดภัย (Security Headers) และ Rate Limit การนำเข้าไฟล์ (5 ครั้ง/ชั่วโมง) + เคลื่อนไหวสต็อก (60 ครั้ง/นาที)

### การตั้งค่าการแจ้งเตือน/อีเมล/LINE Notify
เพิ่มค่าต่อไปนี้ใน `.env` แล้วรัน `php artisan config:clear`:

```env
MAIL_MAILER=smtp
MAIL_HOST=smtp.yourdomain.com
MAIL_PORT=587
MAIL_USERNAME=noreply@yourdomain.com
MAIL_PASSWORD=secret_password
MAIL_FROM_ADDRESS=noreply@yourdomain.com
MAIL_FROM_NAME="ระบบคลังสินค้า"

LINE_NOTIFY_TOKEN=xxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

หากไม่ระบุ `LINE_NOTIFY_TOKEN` ระบบจะข้ามการส่ง LINE พร้อมบันทึกลง log ช่องทาง daily เป็นภาษาไทย

### Scheduler รายวันและคำสั่งที่เกี่ยวข้อง
- ตั้งค่าเวลาสแกนในหน้า **ตั้งค่าระบบ** (ดีฟอลต์ 08:00 น.)
- ตั้ง Cron บนเครื่องโปรดักชันเพื่อรัน Scheduler ทุกนาที:

```cron
* * * * * php /path/to/artisan schedule:run >> /dev/null 2>&1
```

คำสั่งที่สำคัญ:

```bash
php artisan inventory:scan-alerts   # สแกนแจ้งเตือนทันที
php artisan inventory:backup        # สร้างไฟล์สำรอง (ระบบเก็บ 7 ชุดล่าสุด)
```

### สำรองข้อมูลและการกู้คืนเบื้องต้น
- ไฟล์สำรองถูกสร้างใน `storage/app/backups/backup-YYYYmmdd-His.zip`
- ภายใน zip มี `database.json`, `meta.json` และไฟล์ใน `storage/app/public`, `storage/app/tmp`
- สามารถดาวน์โหลดไฟล์จากหน้า `/admin/backup` และนำไปเก็บนอกเซิร์ฟเวอร์เพื่อความปลอดภัย
- สำหรับการกู้คืน ให้แตกไฟล์แล้วนำข้อมูลไป import ตามขั้นตอนของฐานข้อมูลที่ใช้งานจริง (MySQL/PostgreSQL)

### Deployment Checklist
1. ติดตั้ง PHP 8.3 และฐานข้อมูล MySQL 8 หรือ PostgreSQL 15 ขึ้นไป
2. ตั้งค่า `.env` ตามจริง (APP_KEY, APP_ENV=production, APP_URL, MAIL_*, LINE_NOTIFY_TOKEN หากใช้)
3. ตั้งค่า `QUEUE_CONNECTION=database` และรัน `php artisan queue:table && php artisan migrate`
4. ตั้ง Cron `* * * * * php /path/to/artisan schedule:run >> /dev/null 2>&1`
5. กำหนดสิทธิ์โฟลเดอร์ `storage/` และ `bootstrap/cache/`
6. เปิดใช้งาน HTTPS และกำหนด Header `X-Forwarded-*` เมื่ออยู่หลัง Proxy
7. ตรวจสอบให้แน่ใจว่าไฟล์สำรองถูกโอนไปเก็บยังที่ปลอดภัยอย่างสม่ำเสมอ

## แผน Phase ถัดไป (สรุป)
- Phase 2: โมเดลสินค้า/หมวดหมู่ + CRUD
- Phase 3: แดชบอร์ดและสิทธิ์การใช้งานเชิงลึก
- Phase 4: ระบบนำเข้าไฟล์และรายงาน
- Phase 5: ปรับปรุง UX/การพิมพ์รายงาน + ตรวจสอบคุณภาพขั้นสูง (กำลังดำเนินการ)

## หมายเหตุ
- ยังไม่มีเนื้อหาเชิงลอจิกของเมนู (placeholder เท่านั้น)
- ไม่มีไฟล์ไบนารีใน repo; หากต้องใช้จะเพิ่มผ่าน Git LFS ใน Phase ถัดไป
- UI และข้อความทั้งหมดเป็นภาษาไทยเพื่อความเข้าใจง่ายของผู้ใช้งานภายใน

## การรันทดสอบ
```
php tests/run.php
```
คำสั่งด้านบนจะรันชุดทดสอบ Pest แบบ simplified framework ซึ่งครอบคลุมทั้งเคสการนำเข้าสินค้าปกติ, UPSERT, SKIP, การสร้างหมวดหมู่ใหม่ และการส่งออกไฟล์ error.

> **หมายเหตุ:** โปรเจกต์เวอร์ชันนี้รันอยู่บนโครง Laravel แบบ sandbox เพื่อใช้ในการประเมินผล ดังนั้นคำสั่ง `php artisan test` จะไม่พร้อมใช้งานจริง (คลาสของ Laravel Framework ถูกจำลองไว้ในโฟลเดอร์ `stubs/`). กรุณาใช้ `php tests/run.php` สำหรับการตรวจสอบอัตโนมัติแทน
