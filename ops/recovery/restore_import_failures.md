# การกู้คืนเมื่อนำเข้าไฟล์ล้มเหลว

- **เวลาประมาณ**: 20 นาที/ไฟล์ (ขึ้นกับจำนวนแถวที่มี error)
- **สถานการณ์หลัก**: ใช้เมื่อโหมด STRICT ล้มเหลวหรือ LENIENT สร้าง `error.csv`

## Do
- ดาวน์โหลด `error.csv` ทันทีหลังระบบแสดงผล และเก็บสำเนาในโฟลเดอร์ incident
- สื่อสารกับทีมข้อมูลให้แก้เฉพาะแถวที่มี `error_messages`
- ใช้ LENIENT ในรอบกู้คืนเพื่อไม่ให้แถวที่ถูกต้องรอเกินจำเป็น
- บันทึกจำนวนแถว OK / Error ทุกครั้งเพื่อส่งต่อให้ QA

## Don’t
- อย่านำไฟล์เต็ม (ต้นฉบับ) มารัน LENIENT ซ้ำโดยไม่ลบแถวที่ผ่านแล้ว จะทำให้ยอดถูกบวกซ้ำ
- อย่าเปลี่ยน `sub_sku` หรือ `mode` โดยไม่คุยกับทีมสต็อก เพราะจะสร้าง movement ซ้ำหรือคลาดเคลื่อน
- อย่าลบ `error.csv` ต้นฉบับจนกว่าจะยืนยันว่าแถวผิดทั้งหมดได้รับการแก้ไข

## ขั้นตอนการใช้ error.csv
1. เปิด `error.csv` ด้วย Excel/LibreOffice (ระวัง encoding UTF-8)
2. อ่านคอลัมน์ `error_messages` เพื่อตรวจสอบสาเหตุ (เช่น qty ติดลบ, วันหมดอายุผิดรูปแบบ)
3. คัดลอกแถวที่แก้ไขแล้วไปยังไฟล์ใหม่ (รักษา header เดิมและลำดับคอลัมน์)
4. นำเข้าไฟล์ย่อยในโหมด **LENIENT** พร้อมเลือกโหมดนำเข้าที่ถูกต้อง (UPSERT/DELTA/SKIP)
5. ตรวจผลลัพธ์จาก JSON summary ว่า `rows_ok` เพิ่มขึ้น และไม่มี error ใหม่
6. เมื่อทุกแถวผ่าน ให้กลับไปใช้ STRICT และแจ้ง QA รันเทสต์ที่เกี่ยวข้อง

## การสลับ STRICT ↔ LENIENT
- Toggle อยู่ในหน้า "ยืนยันการนำเข้า" ใต้ปุ่ม submit
- หากต้องบังคับ rollback ด้วยตนเอง (เช่น job ค้าง) ให้รันผ่าน CLI ภายใต้ `DB::transaction()` แล้วดูค่า `summary['strict_rolled_back']`
- บันทึกการสลับโหมดใน runbook เพื่อให้ทีมอื่นทราบสถานะ

## ตรวจสอบหลังแก้ไข
- เปิดหน้า **การเคลื่อนไหวสต็อก** ตรวจ movement ล่าสุดว่ามีการสร้าง `receive/adjust` ตรงกับไฟล์ย่อย
- ตรวจ `products.qty` กับ `product_batches.qty` ของสินค้าที่เกี่ยวข้อง (`php artisan tinker` หรือหน้า UI)
- ดาวน์โหลด CSV รายงาน expiring/low-stock อีกครั้งเพื่อตรวจว่าข้อมูลอัปเดตเรียบร้อย
