# A2: เชื่อม UI และบริการเคลื่อนไหวย่อย (Batch/Sub-SKU)

## ภาพรวม UX ใหม่
- ฟอร์มรับเข้า/เบิกออก/ปรับยอดในหน้า "เคลื่อนไหวสต็อก" เพิ่มตัวเลือกล็อต (Sub-SKU)
  - สามารถค้นหาและเลือกล็อตเดิมได้ผ่าน Select2 ตามสินค้า
  - หากไม่เลือกล็อต ระบบจะเลือกล็อตเริ่มต้น `UNSPECIFIED` ให้โดยอัตโนมัติ
  - มีปุ่ม "+ สร้างล็อตใหม่" เปิดโมดัลเพื่อกำหนด Sub-SKU, วันหมดอายุ และหมายเหตุ แล้วเพิ่มเข้า dropdown ทันที
- หน้าแสดงรายละเอียดสินค้า (`/admin/products/{id}`) เพิ่มแท็บแสดงล็อตทั้งหมด พร้อมปุ่มลัดรับเข้า/เบิกออก/ปรับยอดตามล็อตนั้น ๆ
- การแสดงประวัติการเคลื่อนไหวเพิ่มคอลัมน์ล็อต พร้อมแจ้งเตือนกรณีข้อมูลเก่ายังไม่มี batch_id (legacy)

## บริการและ API ที่เกี่ยวข้อง
- `App\Services\BatchResolver` ใช้จัดการ normalize/สร้างล็อตที่จำเป็น (รวมถึง UNSPECIFIED)
- `App\Services\StockMovementService`
  - `receive()` เพิ่มยอดและสร้าง movement ผูก batch
  - `issue()` ลดยอดพร้อมป้องกันคงเหลือติดลบ
  - `adjust()` ปรับยอดให้ตรงตามการตรวจนับ พร้อมบันทึก movement ประเภท adjust
  - ทุกเมธอดเป็นธุรกรรมเดียวกับตาราง `product_batches` และอัปเดต `products.qty` ตามยอดรวมของล็อตที่เปิดใช้งาน
- AJAX สำหรับจัดการล็อต:
  - `POST /admin/products/{product}/batches` (staff/admin เท่านั้น) -> สร้างล็อตใหม่ (คืนค่า JSON พร้อมข้อมูลล็อต)
  - `GET /admin/products/{product}/batches` -> ใช้เติมตัวเลือกใน Select2 เมื่อเลือกสินค้า

## ข้อควรระวังในการปฏิบัติงาน
- ปริมาณยอดในแต่ละล็อตต้องไม่ติดลบ: ระบบจะ throw ValidationException พร้อมข้อความไทยถ้าพยายามเบิกเกิน
- ล็อตเริ่มต้น `SKU-UNSPECIFIED` ยังคงถูกสร้าง/ใช้สำหรับ fallback เพื่อรองรับระบบเก่า
- movement เดิมที่ไม่มี `batch_id` ยังแสดงได้ แต่จะขึ้น badge ว่า legacy เพื่อเตือนว่าควร backfill ให้ครบในอนาคต
- การเพิ่มล็อตใหม่ผ่านหน้าใดหน้าแบบ ajax ต้องใช้บัญชีบทบาท staff ขึ้นไปเท่านั้น

## วิธีทดสอบเร็ว (Smoke Test)
1. **รับเข้า**: เข้าหน้า `/admin/movements`, เลือกสินค้า, กดสร้างล็อตใหม่ (เช่น `LOT-TEST`), รับเข้าจำนวนหนึ่ง ตรวจว่ามี movement และตารางล็อตเพิ่มยอด
2. **เบิกออก**: ใช้สินค้าเดียวกัน เลือกล็อต `LOT-TEST`, เบิกออกบางส่วน ตรวจว่าคงเหลือลดลงและไม่มี error
3. **ปรับยอด**: เลือกล็อตเดิม ปรับยอดให้เหลือค่าที่ต้องการ ตรวจ movement ประเภท adjust และยอดรวมสินค้า
4. **หน้าแสดงสินค้า**: เปิด `/admin/products/{id}` ตรวจว่าตารางล็อตแสดงถูกต้องและปุ่มลัดพาไปหน้าฟอร์มพร้อมกรอกค่าแล้ว
5. **AJAX**: ทดสอบกด "+ เพิ่มล็อต" ทั้งในหน้า movement และ product แล้วตรวจว่าข้อมูลกลับมาถูกต้อง ไม่มีซ้ำ
