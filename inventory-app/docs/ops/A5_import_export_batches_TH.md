# แนวทางการนำเข้า/ส่งออกสต็อกแบบหลายล็อต (A5)

> เอกสารฉบับนี้เป็นร่างแรกสำหรับรอบพัฒนา #A5 โดยสรุปขอบเขตการออกแบบเชิงเทคนิคที่ต้องรองรับการนำเข้า/ส่งออกสต็อกสินค้าแบบหลายล็อต (Batch) และมาตรการลดความเสี่ยงระหว่างดีพลอย

## รูปแบบไฟล์นำเข้า

รองรับทั้ง CSV และ XLSX โดยมีหัวคอลัมน์ภาษาอังกฤษคงที่ตามตารางด้านล่าง (กรณีไม่พบหัวคอลัมน์ให้แสดงข้อผิดพลาดเป็นภาษาไทยทันที)

| column | สถานะ | คำอธิบาย |
| --- | --- | --- |
| `sku` | จำเป็น | รหัสสินค้าแม่ ไม่ต้องมีช่องว่าง | 
| `sub_sku` | จำเป็น | รหัสย่อยของล็อต ความยาวไม่เกิน 64 ตัวอักษร หากเป็น `UNSPECIFIED` ให้ถือเป็นล็อตพิเศษ | 
| `name` | ไม่จำเป็น | ใช้ตั้งชื่อ/อัปเดตชื่อสินค้า | 
| `category` | ไม่จำเป็น | หากระบบเปิด auto-create ให้สร้างหมวดใหม่ได้ | 
| `qty` | จำเป็น | จำนวนยอดคงเหลือต่อล็อต ต้องเป็นจำนวนเต็ม ≥ 0 | 
| `expire_date` | ไม่จำเป็น | รูปแบบ `Y-m-d` หรือเว้นว่าง | 
| `reorder_point` | ไม่จำเป็น | ระดับแจ้งเตือนสต็อกต่ำ (ระดับสินค้า) | 
| `note` | ไม่จำเป็น | บันทึกเพิ่มเติม | 
| `is_active` | ไม่จำเป็น | true/false/1/0 | 

คอลัมน์เกี่ยวกับราคา (เช่น `cost_price`, `sale_price`) จะ **ไม่ถูกใช้งาน** และต้องมีข้อความสรุปแจ้งผู้ใช้เมื่อพบในไฟล์

### ตัวอย่าง CSV

```csv
sku,sub_sku,name,category,qty,expire_date,reorder_point,note,is_active
SKU-001,LOT-A,กาแฟอาราบิก้า,อาหารและเครื่องดื่ม,25,2025-01-31,10,ล็อตแรก,true
SKU-001,LOT-B,กาแฟอาราบิก้า,อาหารและเครื่องดื่ม,12,,10,,true
SKU-002,UNSPECIFIED,ชาเขียว,เครื่องดื่มสุขภาพ,3,2024-12-15,5,ล็อตทดลอง,false
```

## โหมดนำเข้า

1. **UPSERT** (ค่าเริ่มต้น)
   - หา/สร้างสินค้า (`sku`)
   - หา/สร้างล็อต (`product_id`, `sub_sku`)
   - รองรับการตีความจำนวนแบบ **REPLACE** (ตั้งยอดตรง ๆ) หรือ **DELTA** (เพิ่ม/ลดจากเดิม)
   - บันทึก movement แยกประเภท: `adjust` สำหรับ REPLACE, `receive/adjust` สำหรับ DELTA

2. **SKIP**
   - หากพบล็อตเดิมแล้วให้ข้ามโดยไม่แก้ไขยอด
   - หากเป็นล็อตใหม่ให้สร้างพร้อม movement แบบ `receive`

## ระดับความเข้มงวดของธุรกรรม

- **STRICT**: หากเจอแถวผิดเพียงแถวเดียว (ใน chunk ใด ๆ) ให้ rollback ทั้งไฟล์ พร้อมแจ้งผู้ใช้และให้ดาวน์โหลด `error.csv`
- **LENIENT**: commit แถวที่ถูกต้อง ส่วนแถวผิดสะสมลง `error.csv`

การประมวลผลควรแบ่งเป็น chunk (ค่าเริ่มต้น 500 แถว) และอยู่ภายใต้ DB transaction ต่อ chunk พร้อมกลไกรวบรวมสถิติ (สร้างสินค้าใหม่/ล็อตใหม่/ปรับยอด/แถวสำเร็จ/แถวล้มเหลว)

## พรีวิวและ UX

1. ผู้ใช้อัปโหลดไฟล์ → ระบบอ่าน 20 แถวแรกและแสดงในตาราง (Highlight แถวผิด)
2. แสดงข้อความไทยสรุป mapping ของคอลัมน์ + ตัวเลือกโหมด UPSERT (REPLACE/DELTA) หรือ SKIP และ STRICT/LENIENT
3. เมื่อกด "นำเข้า" ระบบประมวลผลและสรุปผลในหน้าผลลัพธ์ พร้อมปุ่มดาวน์โหลด `error.csv`

## สรุปผลหลังประมวลผล

- จำนวนสินค้าที่สร้างใหม่
- จำนวนล็อตใหม่
- จำนวนล็อตที่ปรับยอด
- แถวที่สำเร็จ/ล้มเหลว
- หมายเหตุ "คอลัมน์ราคาถูกเพิกเฉย" หากตรวจพบ

## การส่งออก (Reports)

ต้องเพิ่ม export CSV 2 รายการในรายงาน (#A4):

1. `expiring-batches.csv` — header: `sku,name,sub_sku,expire_date,qty,category`
2. `low-stock.csv` — header: `sku,name,qty_total,reorder_point,category`

ควรใช้มาตรการ escape ป้องกัน CSV injection (เช่น เพิ่ม `'` หากขึ้นต้นด้วย `=+-@`)

## ไฟล์ error.csv

- เก็บใน `storage/app/tmp` หรือโฟลเดอร์ชั่วคราวที่ Laravel เขียนได้
- ชื่อไฟล์มี token เวลาและ random (เช่น `batch_import_errors_YYYYmmddHHMMSS_xxxxxx.csv`)
- ประกอบด้วย `row_number,error_messages` + raw columns ทั้งหมด เพื่อให้ผู้ใช้แก้ไขง่าย
- ลิงก์ดาวน์โหลดต้องเป็น signed URL (หมดอายุ 24 ชั่วโมง)

## ประเด็นด้านประสิทธิภาพ

- ใช้ local cache map สำหรับการค้นหา SKU → Product, `(product_id, sub_sku)` → Batch
- เพิ่ม/ยืนยัน unique index `(product_id, sub_sku)` ในตาราง `product_batches`
- ใช้ `upsert` หรือ `updateOrCreate` เพื่อลดจำนวน query
- ระมัดระวัง N+1 เมื่อสร้าง movement (อาจเก็บข้อมูลก่อนแล้ว bulk insert ได้ในเวอร์ชันต่อไป)

## ขั้นตอนการใช้งานสำหรับทีมปฏิบัติการ

1. เตรียมไฟล์ตามเทมเพลตด้านบน → อัปโหลดที่หน้า "นำเข้า/ส่งออกล็อตสินค้า"
2. ตรวจสอบพรีวิว 20 แถวแรกและคำเตือน (เช่น คอลัมน์ราคาถูกละเลย)
3. เลือกโหมด UPSERT (REPLACE/DELTA) หรือ SKIP และระดับ STRICT/LENIENT
4. กด "ยืนยันนำเข้า" → รอผลลัพธ์ → ดาวน์โหลด `error.csv` หากมีแถวผิด
5. สำหรับโหมด STRICT หากมี error ให้แก้ไฟล์ตาม error.csv แล้วนำเข้าซ้ำทั้งหมด

## ความปลอดภัย & การจัดการเวลา

- ห้ามดีพลอยอัตโนมัติจากสคริปต์นำเข้า (สอดคล้องกับข้อกำหนด "ห้ามก่อให้เกิดดีพลอยจริงอัตโนมัติ")
- ตรวจสอบ timezone: ใช้ `config('app.timezone')` สำหรับ transaction log แต่แสดงวันที่ในสรุปตามรูปแบบ `Y-m-d`
- เมื่อมีการ export ให้ใช้ `response()->streamDownload()` เพื่อลดหน่วยความจำและตั้ง header `Content-Type: text/csv; charset=UTF-8`

## การทดสอบ (Pest)

- `tests/Feature/Import/A5_BatchImportTest.php`
  - ครอบคลุมพรีวิว, UPSERT-REPLACE, UPSERT-DELTA, SKIP, STRICT vs LENIENT, การเพิกเฉยคอลัมน์ราคา
- `tests/Feature/Export/A5_ReportsExportTest.php`
  - ตรวจ header และข้อมูลสำหรับไฟล์ expiring/low-stock ว่าไม่มีคอลัมน์ราคา

> TODO: หลังทีมพัฒนา implement แล้วให้ปรับเอกสารนี้เป็นคู่มือทางการ พร้อมแนบภาพหน้าจอจากระบบจริง
